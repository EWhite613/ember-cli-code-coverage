<script>
  function sendCoverage(callback) {
    var coverageData = window.__coverage__;
    var data = JSON.stringify(coverageData || {});

    $.ajax({
      type: 'POST',
      async: false,
      url: '/write-coverage',
      datatype: 'json',
      contentType:'application/json; charset=utf-8',
      data: data,
      error: function(jqXHR, textStatus, errorThrown ) {
        throw errorThrown;
      },
      success: function(data) {
        if (!data || !data.total) {
          return;
        }

        var results = ['Lines', 'Branches', 'Functions', 'Statements']
          .filter(function (name) {
            return data.total[name.toLowerCase()]
          })
          .map(function (name) {
            return name + ' ' + data.total[name.toLowerCase()].pct + '%'
          })

        $('body').append('<div style="background-color: white; color: black; border: 2px solid black; padding: 1em;position: fixed; left: 15px; bottom: 15px">' + results.join(' | ') + '</div>');
      },
      complete: function() {
        if (callback) {
          callback();
        }
      }
    });
  }

  function getModuleName (){
    return jQuery.ajax({
        url: '/get-module-name',
        async: false
    }).responseJSON // TODO: async after POC
  }
  function shouldExclude(moduleName){
    return jQuery.ajax({
      type: 'POST',      
      url: '/should-exclude',
      async: false,
      data: {
       moduleName: moduleName 
      }
    }).responseJSON
  }
  if (typeof Testem !== "undefined" && Testem.afterTests) {
    Testem.afterTests(function(config, data, callback) {
      var seen = {}
      var appName = getModuleName().appName
      for (var moduleName in requirejs.entries) {
        if (typeof(seen[moduleName]) === 'undefined') {
          var parts = moduleName.split('/')
            try {
              if (parts.length >= 1 && parts[0] === appName || parts.length >= 2 && parts[0] === 'dummy' && parts[1] === appName){
                  if (!shouldExclude(moduleName).result){
                    console.warn('requiring unseen module: ' + moduleName)
                    require(moduleName);
                  }
                  seen[moduleName] = true;                  
              }   
            } catch (err) {
              console.log(err);
            }
        }
      }
      sendCoverage(callback);
    });
  } else if (typeof QUnit !== "undefined") {
    QUnit.done(function() {
      sendCoverage();
    });
  }
</script>
